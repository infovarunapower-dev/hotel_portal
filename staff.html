<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Staff Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  .tab { padding:8px 14px; background:#e5e7eb; border-radius:6px; cursor:pointer; }
  .tab-active { background:#2563eb; color:white; }
  .card { background:white; padding:14px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.08); margin-bottom:12px; }
  .status { padding:4px 7px; border-radius:6px; font-size:12px; color:white; font-weight:600; }
  .Assigned { background:#2563eb; }
  .Pending { background:#6b7280; }
  .InProgress { background:#f59e0b; }
  .Completed { background:#16a34a; }
</style>
</head>

<body class="bg-gray-100 p-5">

<div class="max-w-3xl mx-auto">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Staff Dashboard</h2>
    <div>
      <span id="staffName" class="font-medium"></span>
      <button id="logout" class="underline text-blue-600 ml-3">Logout</button>
    </div>
  </div>

  <p class="text-sm text-gray-600 mb-3">
    Tasks assigned to you will appear here. Click any task to view full details.
  </p>

  <!-- Tabs -->
  <div class="flex gap-3 mb-4">
    <div class="tab tab-active" data-tab="pending">Pending</div>
    <div class="tab" data-tab="inprogress">In Progress</div>
    <div class="tab" data-tab="completed">Completed</div>
    <div class="tab" data-tab="history">History</div>
  </div>

  <!-- Task list -->
  <div id="taskList"></div>

</div>

<!-- MODAL -->
<div id="modalBg"
     class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div id="modalBox" class="bg-white p-5 rounded-xl max-w-md w-11/12"></div>
</div>

<script>
/* -------------------------------
   STAFF LOGIN VALIDATION
-------------------------------- */
const staffAuth = JSON.parse(localStorage.getItem("staffAuth") || "null");
if (!staffAuth || !staffAuth.name){
  alert("Please login as staff");
  location.href = "login.html";
}

document.getElementById("staffName").innerText = staffAuth.name;

/* -------------------------------
   LOAD TASKS
-------------------------------- */
function getRequests(){
  return JSON.parse(localStorage.getItem("requests") || "[]");
}

/* -------------------------------
   TABS
-------------------------------- */
let activeTab = "pending";
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("tab-active"));
    tab.classList.add("tab-active");
    activeTab = tab.dataset.tab;
    render();
  };
});

/* -------------------------------
   RENDER TASKS
-------------------------------- */
function render(){
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  const all = getRequests();

  // Only tasks assigned to this staff
  const mine = all.filter(r => r.assigned_to === staffAuth.name);

  let filtered = [];

  if(activeTab === "pending"){
    filtered = mine.filter(r => r.status === "Assigned" || r.status === "Pending");
  }
  if(activeTab === "inprogress"){
    filtered = mine.filter(r => r.status === "In Progress");
  }
  if(activeTab === "completed"){
    filtered = mine.filter(r => r.status === "Completed");
  }
  if(activeTab === "history"){
    filtered = mine; // show all assigned
  }

  if(filtered.length === 0){
    list.innerHTML = `<p class="text-gray-600 text-sm">No tasks found.</p>`;
    return;
  }

  filtered.forEach((task, idx)=>{
    const card = document.createElement("div");
    card.className = "card cursor-pointer";

    card.innerHTML = `
      <div class="flex justify-between">
        <div>
          <div class="font-semibold">${task.service}</div>
          <div class="text-sm text-gray-600">Room ${task.room} â€” ${task.type}</div>
        </div>
        <div class="status ${task.status.replace(" ","")}">${task.status}</div>
      </div>

      <div class="text-xs text-gray-500 mt-2">${task.created_at}</div>

      <div class="mt-3 flex gap-2">
        ${
          (task.status === "Assigned" || task.status === "Pending")
          ? `<button class="px-3 py-1 bg-amber-500 text-white rounded startBtn" data-id="${task.id}">Start</button>`
          : ""
        }
        ${
          task.status === "In Progress"
          ? `<button class="px-3 py-1 bg-green-600 text-white rounded completeBtn" data-id="${task.id}">Complete</button>`
          : ""
        }
      </div>
    `;

    // Summary when clicking card
    card.onclick = (e)=>{
      if(e.target.classList.contains("startBtn") || e.target.classList.contains("completeBtn"))
        return;
      openSummary(task);
    };

    list.appendChild(card);
  });
}

/* -------------------------------
   BUTTON ACTIONS
-------------------------------- */
document.addEventListener("click", e=>{
  const all = getRequests();

  // Start
  if(e.target.classList.contains("startBtn")){
    const id = e.target.dataset.id;
    const idx = all.findIndex(r => r.id == id);
    if(idx > -1){
      all[idx].status = "In Progress";
      all[idx].updated_at = new Date().toLocaleString();
      localStorage.setItem("requests", JSON.stringify(all));
      render();
    }
  }

  // Complete
  if(e.target.classList.contains("completeBtn")){
    const id = e.target.dataset.id;
    const idx = all.findIndex(r => r.id == id);
    if(idx > -1){
      all[idx].status = "Completed";
      all[idx].updated_at = new Date().toLocaleString();
      localStorage.setItem("requests", JSON.stringify(all));
      render();
    }
  }
});

/* -------------------------------
   SUMMARY MODAL
-------------------------------- */
function openSummary(task){
  const box = document.getElementById("modalBox");

  box.innerHTML = `
    <h3 class="text-xl font-semibold mb-2">Task Summary</h3>

    <p><strong>Service:</strong> ${task.service}</p>
    <p><strong>Category:</strong> ${task.type}</p>
    <p><strong>Room:</strong> ${task.room}</p>
    <p><strong>Request:</strong> ${task.details}</p>
    <p><strong>Status:</strong> ${task.status}</p>

    <div class="text-right mt-4">
      <button onclick="closeModal()" class="px-4 py-1 bg-gray-300 rounded">Close</button>
    </div>
  `;

  document.getElementById("modalBg").classList.remove("hidden");
}

function closeModal(){
  document.getElementById("modalBg").classList.add("hidden");
}

/* -------------------------------
   LOGOUT
-------------------------------- */
document.getElementById("logout").onclick = ()=>{
  localStorage.removeItem("staffAuth");
  location.href = "login.html";
};

render();
</script>
</body>
</html>
