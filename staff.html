<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Staff Dashboard - Hotel Portal</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  .tab-active { background:#2563eb; color:white; }
  .tab { padding:8px 14px; border-radius:6px; cursor:pointer; background:#e5e7eb; }
  .card { background:white; padding:14px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.08); margin-bottom:12px; }
  .status { font-size:13px; font-weight:600; padding:4px 6px; border-radius:6px; color:white; }
  .Pending { background:#6b7280; }
  .InProgress { background:#f59e0b; }
  .Completed { background:#16a34a; }
</style>
</head>

<body class="bg-gray-100 p-5">

<div class="max-w-3xl mx-auto">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Staff Dashboard</h2>
    <div>
      <span id="staffName" class="font-medium"></span>
      <button id="logout" class="underline text-blue-600 ml-3">Logout</button>
    </div>
  </div>

  <p class="text-sm text-gray-600 mb-3">
    View & complete your assigned tasks. Tap any card to view full order summary.
  </p>

  <!-- Tabs -->
  <div class="flex gap-3 mb-4">
    <div class="tab tab-active" data-tab="pending">Pending</div>
    <div class="tab" data-tab="inprogress">In Progress</div>
    <div class="tab" data-tab="completed">Completed</div>
    <div class="tab" data-tab="history">History</div>
  </div>

  <!-- Content -->
  <div id="taskList"></div>

</div>

<!-- Modal -->
<div id="modalBg" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div id="modalBox" class="bg-white p-5 rounded-xl max-w-md w-11/12 shadow-xl"></div>
</div>

<script>
/* -----------------------------
   FIREBASE INIT
------------------------------ */
var firebaseConfig = {
  apiKey: "AIzaSyDpSKRN8iYOosANJXLYnxvfILXYmtRgq5Q",
  authDomain: "hotel-management-93d66.firebaseapp.com",
  databaseURL: "https://hotel-management-93d66-default-rtdb.firebaseio.com",
  projectId: "hotel-management-93d66",
  storageBucket: "hotel-management-93d66.firebasestorage.app",
  messagingSenderId: "937368960990",
  appId: "1:937368960990:web:9e6425dfcc63f96844e74f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -----------------------------
   STAFF AUTH
------------------------------ */
const staffAuth = JSON.parse(localStorage.getItem('staffAuth') || "null");
if(!staffAuth || !staffAuth.name){
  alert("Please login as staff");
  location.href = "login.html";
}
document.getElementById("staffName").innerText = staffAuth.name;

/* -----------------------------
   TABS
------------------------------ */
let activeTab = "pending";
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("tab-active"));
    tab.classList.add("tab-active");
    activeTab = tab.dataset.tab;
    render();
  });
});

/* -----------------------------
   DATA FETCH (REALTIME)
------------------------------ */
let requests = {};
db.ref("requests").on("value", snap=>{
  requests = snap.val() || {};
  render();
});

/* -----------------------------
   RENDER
------------------------------ */
function render(){
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  const arr = Object.keys(requests).map(id => ({ id, ...requests[id] }));
  const mine = arr.filter(r => r.assigned_to === staffAuth.name);

  let filtered = [];

  if(activeTab === "pending"){
    filtered = mine.filter(r=>r.status === "Pending");
  }
  if(activeTab === "inprogress"){
    filtered = mine.filter(r=>r.status === "In Progress");
  }
  if(activeTab === "completed"){
    filtered = mine.filter(r=>r.status === "Completed");
  }
  if(activeTab === "history"){
    filtered = mine; // Show all assigned tasks
  }

  if(filtered.length === 0){
    list.innerHTML = `<p class="text-gray-600 text-sm">No tasks available.</p>`;
    return;
  }

  filtered.forEach(task => {
    const div = document.createElement("div");
    div.className = "card cursor-pointer";
    div.innerHTML = `
      <div class="flex justify-between">
        <div>
          <div class="font-semibold">${task.service}</div>
          <div class="text-sm text-gray-600">Room ${task.room} â€” ${task.type}</div>
        </div>
        <div class="status ${task.status.replace(' ','')}">${task.status}</div>
      </div>
      <div class="text-xs text-gray-500 mt-2">${new Date(task.created_at).toLocaleString()}</div>

      ${
        task.status !== "Completed"
        ? `<div class="mt-3 flex gap-2">
             <button class="px-3 py-1 bg-amber-500 text-white rounded startBtn" data-id="${task.id}">Start</button>
             <button class="px-3 py-1 bg-green-600 text-white rounded completeBtn" data-id="${task.id}">Complete</button>
           </div>`
        : ""
      }
    `;

    // Open summary modal on click
    div.onclick = (e)=>{
      if(e.target.classList.contains("startBtn") || e.target.classList.contains("completeBtn")) return;
      openSummary(task);
    };

    list.appendChild(div);
  });
}

/* -----------------------------
   UPDATE STATUS
------------------------------ */
document.addEventListener("click", e=>{
  if(e.target.classList.contains("startBtn")){
    const id = e.target.dataset.id;
    db.ref("requests/" + id).update({
      status: "In Progress",
      updated_at: new Date().toISOString()
    });
  }
  if(e.target.classList.contains("completeBtn")){
    const id = e.target.dataset.id;
    db.ref("requests/" + id).update({
      status: "Completed",
      updated_at: new Date().toISOString()
    });
  }
});

/* -----------------------------
   SUMMARY MODAL
------------------------------ */
function openSummary(task){
  const html = `
    <h3 class="text-xl font-semibold mb-2">Request Summary</h3>
    <p><strong>Service:</strong> ${task.service}</p>
    <p><strong>Category:</strong> ${task.type}</p>
    <p><strong>Room:</strong> ${task.room}</p>
    <p><strong>Guest:</strong> ${task.name}</p>
    <p><strong>Details:</strong> ${task.details}</p>
    <p><strong>Status:</strong> ${task.status}</p>
    <p class="text-xs text-gray-500 mt-2">${new Date(task.created_at).toLocaleString()}</p>

    <div class="text-right mt-4">
      <button onclick="closeModal()" class="px-4 py-1 bg-gray-300 rounded">Close</button>
    </div>
  `;
  document.getElementById("modalBox").innerHTML = html;
  document.getElementById("modalBg").classList.remove("hidden");
}

function closeModal(){
  document.getElementById("modalBg").classList.add("hidden");
}

/* -----------------------------
   LOGOUT
------------------------------ */
document.getElementById("logout").onclick = ()=>{
  localStorage.removeItem("staffAuth");
  location.href = "login.html";
};
</script>

</body>
</html>
