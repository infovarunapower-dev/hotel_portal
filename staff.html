<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Staff Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<script src="https://cdn.tailwindcss.com"></script>

<style>
  .tab { padding:8px 14px; background:#e5e7eb; border-radius:6px; cursor:pointer; }
  .tab-active { background:#2563eb; color:white; }
  .card { background:white; padding:14px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.08); margin-bottom:12px; }
  .status { padding:4px 7px; border-radius:6px; font-size:12px; color:white; font-weight:600; }
  .Pending { background:#6b7280; }
  .Assigned { background:#2563eb; }
  .In\ Progress { background:#f59e0b; }
  .Completed { background:#16a34a; }
</style>
</head>

<body class="bg-gray-100 p-5">

<div class="max-w-3xl mx-auto">

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Staff Dashboard</h2>
    <div>
      <span id="staffName" class="font-medium"></span>
      <button id="logout" class="underline text-blue-600 ml-3">Logout</button>
    </div>
  </div>

  <p class="text-sm text-gray-600 mb-3">
    Tasks assigned to you will appear here.
  </p>

  <!-- Tabs -->
  <div class="flex gap-3 mb-4">
    <div class="tab tab-active" data-tab="pending">Pending</div>
    <div class="tab" data-tab="inprogress">In Progress</div>
    <div class="tab" data-tab="completed">Completed</div>
    <div class="tab" data-tab="history">History</div>
  </div>

  <div id="taskList"></div>
</div>

<!-- Modal -->
<div id="modalBg" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div id="modalBox" class="bg-white p-5 rounded-xl max-w-md w-11/12"></div>
</div>

<script>
/* LOGIN CHECK */
const staffAuth = JSON.parse(localStorage.getItem("staffAuth") || "null");
if (!staffAuth){ location.href = "login.html"; }
document.getElementById("staffName").innerText = staffAuth.name;

/* GET REQUESTS */
function getRequests(){ return JSON.parse(localStorage.getItem("requests") || "[]"); }
function saveRequests(r){ localStorage.setItem("requests", JSON.stringify(r)); }

/* TABS */
let activeTab = "pending";
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("tab-active"));
    tab.classList.add("tab-active");
    activeTab = tab.dataset.tab;
    render();
  };
});

/* RENDER TASKS */
function render(){
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  const all = getRequests();
  const my = all.map((task, index) => ({...task, index})) // keep index mapping
                 .filter(t => t.assigned_to === staffAuth.name);

  let filtered = my;

  if(activeTab === "pending"){
    filtered = my.filter(t => t.status === "Assigned");
  }
  if(activeTab === "inprogress"){
    filtered = my.filter(t => t.status === "In Progress");
  }
  if(activeTab === "completed"){
    filtered = my.filter(t => t.status === "Completed");
  }
  if(activeTab === "history"){
    filtered = my;
  }

  if(filtered.length === 0){
    list.innerHTML = `<p class="text-gray-500 text-sm">No tasks here.</p>`;
    return;
  }

  filtered.forEach(t => {
    list.innerHTML += `
      <div class="card">
        <div class="flex justify-between">
          <div>
            <h3 class="font-semibold">${t.service}</h3>
            <p class="text-sm text-gray-600">${t.details || ""}</p>
            <p class="text-sm text-gray-700 font-medium">Room: ${t.room}</p>
            <p class="status ${t.status.replace(" ","")}">${t.status}</p>
          </div>

          <div class="flex flex-col gap-2 ml-4">
            ${t.status === "Assigned" ? `<button class="bg-orange-500 text-white px-3 py-1 rounded startBtn" data-index="${t.index}">Start</button>` : ""}
            ${t.status === "In Progress" ? `<button class="bg-green-600 text-white px-3 py-1 rounded completeBtn" data-index="${t.index}">Complete</button>` : ""}
          </div>
        </div>
      </div>
    `;
  });
}

/* ACTION HANDLING */
document.addEventListener("click", e => {
  const all = getRequests();

  // Start task
  if(e.target.classList.contains("startBtn")){
    const idx = Number(e.target.dataset.index);
    all[idx].status = "In Progress";
    all[idx].updated_at = new Date().toLocaleString();
    saveRequests(all);
    render();
  }

  // Complete task
  if(e.target.classList.contains("completeBtn")){
    const idx = Number(e.target.dataset.index);
    all[idx].status = "Completed";
    all[idx].updated_at = new Date().toLocaleString();
    saveRequests(all);
    render();
  }
});

/* LOGOUT */
document.getElementById("logout").onclick = ()=>{
  localStorage.removeItem("staffAuth");
  location.href = "login.html";
};

render();
</script>

</body>
</html>
