<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard ‚Äî Food Editor (Auto-save)</title>

<style>
*{box-sizing:border-box;font-family:Inter,Arial,Helvetica,sans-serif}
body{background:#f4f6fb;color:#0f172a;margin:0;font-size:14px}
header{height:52px;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:60}
header .brand{font-weight:700}
header a{color:#fff;text-decoration:underline;font-size:13px;margin-left:12px}
.layout{display:flex;min-height:calc(100vh - 52px)}
.sidebar{width:260px;background:#fff;border-right:1px solid #e6eef6;padding:14px;display:flex;flex-direction:column;gap:6px}
.sidebar h3{font-size:13px;color:#64748b;margin:0 0 8px}
.sb-item{padding:9px 10px;border-radius:6px;cursor:pointer;color:#334155;display:flex;align-items:center;gap:8px}
.sb-item:hover{background:#f1f5f9}
.sb-item.active{background:#2563eb;color:#fff}
main{flex:1;padding:14px}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
.controls .search{flex:1;min-width:200px;display:flex;gap:6px}
.controls input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6edf6;background:#fff}
.controls select,.controls button{padding:8px;border-radius:8px;border:1px solid #e6edf6;background:#fff}
.card{background:#fff;padding:10px;border-radius:8px;flex:1;min-width:120px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
.table-wrap{background:#fff;border-radius:10px;overflow:hidden;border:1px solid #e6eef6}
table{width:100%;border-collapse:collapse}
thead th{background:#fbfdff;padding:10px 12px;color:#64748b;text-align:left;font-weight:600;border-bottom:1px solid #f1f5f9}
tbody td{padding:10px 12px;border-bottom:1px solid #f6f8fb;vertical-align:middle}
tbody tr:hover td{background:#fbfcff}
.status-badge{display:inline-block;padding:6px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
.status-Pending{background:#6b7280}
.status-InProgress{background:#f59e0b}
.status-Completed{background:#16a34a}
.status-Ignored{background:#94a3b8}
.btn{padding:7px 12px;border-radius:6px;border:0;color:#fff;cursor:pointer;font-size:13px}
.btn-next{background:#2563eb}
.btn-ignore{background:#6b7280}
.btn-delete{background:#ef4444}
.btn-ghost{background:#fff;border:1px solid #e2e8f0;color:#334155}
.action-group{display:flex;gap:8px;flex-wrap:wrap}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:2000}
.modal{background:#fff;padding:16px;border-radius:10px;max-width:720px;width:94%;box-shadow:0 12px 30px rgba(2,6,23,0.12)}
.small-muted{font-size:12px;color:#6b7280}

/* Food editor styles */
.food-editor { padding:18px; }
.food-editor h4 { margin:0 0 8px; }
.cat-box { border:1px dashed #e6eef6; padding:12px; border-radius:8px; margin-bottom:12px; background:#fbfdff; }
.item-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
.item-row input { padding:8px; border-radius:6px; border:1px solid #e6eef6; }
.item-row button { padding:6px 10px; border-radius:6px; cursor:pointer; }
.small-btn { padding:6px 8px; border-radius:6px; border:1px solid #e6eef6; background:#fff; cursor:pointer; }
.save-btn{ background:#10b981; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
.cancel-btn{ background:#ef4444; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; margin-left:8px;}
.note { font-size:13px;color:#475569;margin-top:8px; }
</style>
</head>

<body>

<header>
    <div class="brand">Admin Dashboard</div>
    <div>
        <a href="index.html">Home</a>
        <a href="login.html">Logout</a>
    </div>
</header>

<div class="layout">

<!-- SIDEBAR -->
<aside class="sidebar">
    <h3>ADMIN MENU</h3>
    <div class="sb-item active" data-action="dashboard">üìã Dashboard</div>
    <div class="sb-item" data-action="food-menu">üçΩ Food Menu</div>
    <div class="sb-item" data-action="settings">‚öô Settings</div>
</aside>

<!-- MAIN -->
<main>

<div class="controls">
    <div class="search">
        <input id="searchInput" type="text" placeholder="Search room, guest, service, details...">
        <button id="clearSearch" class="btn-ghost">Clear</button>
    </div>

    <select id="categoryFilter">
        <option value="">All Categories</option>
        <option>Housekeeping</option>
        <option>Travel</option>
        <option>Food</option>
    </select>

    <select id="statusFilter">
        <option value="">All Status</option>
        <option>Pending</option>
        <option>In Progress</option>
        <option>Completed</option>
        <option>Ignored</option>
    </select>

    <button id="refreshBtn" class="btn-ghost">Refresh</button>
</div>

<!-- TABLE (Dashboard view) -->
<div class="table-wrap" id="dashboardView">
    <table id="reqTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Category</th>
                <th>Service / Details</th>
                <th>Guest</th>
                <th>Room</th>
                <th>Time</th>
                <th>Scheduled</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Food editor view -->
<div id="foodView" style="display:none;">
  <div class="food-editor">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h3 style="margin:0">Food Menu Editor</h3>
        <div class="small-muted">Add / edit categories and items. Changes are saved automatically and will show on the landing page.</div>
      </div>
      <div>
        <button id="foodSave" class="save-btn">Save (force)</button>
        <button id="foodDiscard" class="cancel-btn">Discard</button>
      </div>
    </div>

    <div id="foodListContainer"></div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <input id="newCategoryName" placeholder="New category name (e.g. Dinner)" style="padding:8px;border-radius:6px;border:1px solid #e6eef6"/>
      <button id="addCategoryBtn" class="small-btn">Add Category</button>
    </div>

    <div class="note">
      Tip: changes are auto-saved. Use "Discard" to reload the last saved menu from storage.
    </div>

    <div style="margin-top:18px;">
      <button id="openLandingPreview" class="btn-ghost">Open Landing Page Preview</button>
    </div>
  </div>
</div>

</main>
</div>

<!-- Modal used by settings -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="modalBox" class="modal"></div>
</div>

<script>
// -------------------------------
// LocalStorage helpers
// -------------------------------
function loadRequests(){ return JSON.parse(localStorage.getItem("requests") || "[]"); }
function saveRequests(d){ localStorage.setItem("requests", JSON.stringify(d)); }

function loadFood(){ 
  try { return JSON.parse(localStorage.getItem("foodMenu") || "{}"); } 
  catch(e){ return {}; }
}
function saveFood(obj){ 
  localStorage.setItem("foodMenu", JSON.stringify(obj)); 
  // bump a timestamp so other tabs reliably get storage event
  try { localStorage.setItem('foodMenu_updated_at', new Date().toISOString()); } catch(e){}
}

// -------------------------------
// Dashboard table rendering
// -------------------------------
function formatScheduled(s){
    if(!s) return "";
    if(s === "ASAP") return "ASAP";
    const d = new Date(s);
    if(!isNaN(d)) return d.toLocaleString();
    return String(s);
}

function renderTable(){
    const all = loadRequests();
    const tbody = document.querySelector("#reqTable tbody");
    tbody.innerHTML = "";

    const search = searchInput.value.toLowerCase();
    const cat = categoryFilter.value;
    const status = statusFilter.value;

    all.forEach((r, i) => {
        if(cat && r.type !== cat) return;
        if(status && r.status !== status) return;

        const hay = `${r.service} ${r.details || ""} ${r.room || ""} ${r.name || ""}`.toLowerCase();
        if(search && !hay.includes(search)) return;

        const nextBtn =
            r.status === "Pending" ? "Start" :
            r.status === "In Progress" ? "Complete" :
            "";

        const scheduledText = formatScheduled(r.scheduled_at);

        tbody.insertAdjacentHTML("beforeend", `
        <tr>
            <td>${i+1}</td>
            <td>${r.type || ""}</td>
            <td>${r.service || ""} ${r.details ? '‚Äî <small class="small-muted">'+(r.details||"")+'</small>' : ''}</td>
            <td>${r.name || "Guest"}</td>
            <td>${r.room || ""}</td>
            <td>${r.created_at ? (new Date(r.created_at).toLocaleString()) : (r.time||"")}</td>
            <td>${scheduledText}</td>
            <td><span class="status-badge status-${(r.status||'').replace(" ","")}">${r.status || ""}</span></td>
            <td>
                <div class="action-group">
                    ${nextBtn ? `<button class="btn btn-next" data-next="${i}">${nextBtn}</button>` : ""}
                    <button class="btn btn-ignore" data-ignore="${i}">Ignore</button>
                    <button class="btn btn-delete" data-delete="${i}">Delete</button>
                </div>
            </td>
        </tr>
        `);
    });
}

// Next step workflow (start/complete/ignore/delete)
document.addEventListener("click", e => {
    const all = loadRequests();

    if(e.target.dataset.next){
        const i = +e.target.dataset.next;
        if(!all[i]) return;
        if(all[i].status === "Pending") all[i].status = "In Progress";
        else if(all[i].status === "In Progress") all[i].status = "Completed";
        all[i].updated_at = new Date().toISOString();
        saveRequests(all);
        renderTable();
    }

    if(e.target.dataset.ignore){
        const i = +e.target.dataset.ignore;
        if(!all[i]) return;
        all[i].status = "Ignored";
        all[i].updated_at = new Date().toISOString();
        saveRequests(all);
        renderTable();
    }

    if(e.target.dataset.delete){
        const i = +e.target.dataset.delete;
        if(!all[i]) return;
        all.splice(i,1);
        saveRequests(all);
        renderTable();
    }
});

// Filters & actions
searchInput.addEventListener("input", renderTable);
categoryFilter.addEventListener("change", renderTable);
statusFilter.addEventListener("change", renderTable);
clearSearch.addEventListener("click", ()=>{ searchInput.value=""; renderTable(); });
refreshBtn.addEventListener("click", renderTable);

// -------------------------------
// Sidebar navigation handling
// -------------------------------
document.querySelectorAll('.sb-item').forEach(item=>{
  item.addEventListener('click', ()=> {
    // visual active toggle
    document.querySelectorAll('.sb-item').forEach(s => s.classList.remove('active'));
    item.classList.add('active');

    const action = item.dataset.action;
    if(action === 'dashboard'){
      document.getElementById('dashboardView').style.display = '';
      document.getElementById('foodView').style.display = 'none';
      renderTable();
    } else if(action === 'food-menu'){
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('foodView').style.display = '';
      loadFoodEditor();
    } else if(action === 'settings'){
      openSettingsModal();
    }
  });
});

// -------------------------------
// Food menu editor (immediate reflect + autosave)
// -------------------------------
let foodDraft = {}; // current working draft (in-memory)

function safeClone(obj){ return JSON.parse(JSON.stringify(obj || {})); }

// create category box UI from draft
function createCategoryBox(catName, items){
  const wrapper = document.createElement('div');
  wrapper.className = 'cat-box';
  wrapper.dataset.cat = catName;

  const header = document.createElement('div');
  header.style.display = 'flex';
  header.style.justifyContent = 'space-between';
  header.style.alignItems = 'center';

  const title = document.createElement('h4');
  title.innerText = catName;
  title.style.margin = '0';

  const headerRight = document.createElement('div');

  const renameBtn = document.createElement('button');
  renameBtn.className = 'small-btn';
  renameBtn.innerText = 'Rename';
  renameBtn.onclick = ()=> {
    const newName = prompt('Rename category', catName);
    if(newName && newName.trim()){
      if(foodDraft[newName] && newName !== catName) { alert('Category exists'); return; }
      foodDraft[newName] = foodDraft[catName];
      if(newName !== catName) delete foodDraft[catName];
      // auto-save and re-render
      saveFood(foodDraft);
      loadFoodEditor();
    }
  };

  const delCatBtn = document.createElement('button');
  delCatBtn.className = 'small-btn';
  delCatBtn.style.marginLeft = '8px';
  delCatBtn.innerText = 'Delete Category';
  delCatBtn.onclick = ()=> {
    if(confirm('Delete category "'+catName+'"?')) {
      delete foodDraft[catName];
      saveFood(foodDraft);
      loadFoodEditor();
    }
  };

  headerRight.appendChild(renameBtn);
  headerRight.appendChild(delCatBtn);

  header.appendChild(title);
  header.appendChild(headerRight);
  wrapper.appendChild(header);

  // items list
  const itemsDiv = document.createElement('div');
  itemsDiv.style.marginTop = '8px';

  (items || []).forEach((it, idx) => {
    const row = document.createElement('div');
    row.className = 'item-row';
    const nameInput = document.createElement('input');
    nameInput.className = 'item-name';
    nameInput.value = it.name;
    const priceInput = document.createElement('input');
    priceInput.className = 'item-price';
    priceInput.style.width = '110px';
    priceInput.value = String(it.price);

    const saveBtn = document.createElement('button');
    saveBtn.className = 'small-btn';
    saveBtn.innerText = 'Save';
    saveBtn.onclick = ()=> {
      const newName = nameInput.value.trim();
      const newPrice = priceInput.value.trim();
      if(!newName || isNaN(Number(newPrice))) return alert('Enter valid name and numeric price');
      foodDraft[catName][idx] = { name: newName, price: String(Number(newPrice)) };
      saveFood(foodDraft); // immediate persist
      loadFoodEditor();
    };

    const removeBtn = document.createElement('button');
    removeBtn.className = 'small-btn';
    removeBtn.style.marginLeft = '6px';
    removeBtn.innerText = 'Remove';
    removeBtn.onclick = ()=> {
      if(confirm('Remove "'+it.name+'"?')) {
        foodDraft[catName].splice(idx,1);
        saveFood(foodDraft);
        loadFoodEditor();
      }
    };

    row.appendChild(nameInput);
    row.appendChild(priceInput);
    row.appendChild(saveBtn);
    row.appendChild(removeBtn);

    itemsDiv.appendChild(row);
  });

  // add item row
  const addRow = document.createElement('div');
  addRow.className = 'item-row';
  addRow.style.marginTop = '10px';
  const newName = document.createElement('input');
  newName.className = 'new-item-name';
  newName.placeholder = 'Item name';
  const newPrice = document.createElement('input');
  newPrice.className = 'new-item-price';
  newPrice.placeholder = 'Price';
  newPrice.style.width = '110px';
  const addBtn = document.createElement('button');
  addBtn.className = 'small-btn';
  addBtn.innerText = 'Add Item';
  addBtn.onclick = ()=> {
    const nm = newName.value.trim();
    const pr = newPrice.value.trim();
    if(!nm || isNaN(Number(pr))) return alert('Enter valid name and numeric price');
    if(!foodDraft[catName]) foodDraft[catName] = [];
    foodDraft[catName].push({ name: nm, price: String(Number(pr)) });
    // auto-save & re-render
    saveFood(foodDraft);
    loadFoodEditor();
  };

  addRow.appendChild(newName);
  addRow.appendChild(newPrice);
  addRow.appendChild(addBtn);

  wrapper.appendChild(itemsDiv);
  wrapper.appendChild(addRow);
  return wrapper;
}

function loadFoodEditor(){
  // read from storage fresh
  foodDraft = safeClone(loadFood());
  const container = document.getElementById('foodListContainer');
  container.innerHTML = '';
  const keys = Object.keys(foodDraft);
  if(keys.length === 0){
    container.innerHTML = '<div class="small-muted">No categories yet. Add one below.</div>';
  } else {
    keys.forEach(k=>{
      container.appendChild(createCategoryBox(k, foodDraft[k]));
    });
  }
  document.getElementById('newCategoryName').value = '';
}

// add new category (auto-saved)
document.getElementById('addCategoryBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newCategoryName').value.trim();
  if(!name) return alert('Enter a category name');
  // load fresh in case of concurrent edits
  foodDraft = safeClone(loadFood());
  if(foodDraft[name]) return alert('Category already exists');
  foodDraft[name] = [];
  saveFood(foodDraft);
  loadFoodEditor();
});

// Save (force) and Discard
document.getElementById('foodSave').addEventListener('click', ()=>{
  saveFood(foodDraft);
  alert('Food menu saved.');
});
document.getElementById('foodDiscard').addEventListener('click', ()=>{
  if(confirm('Discard unsaved changes and reload saved menu?')) {
    loadFoodEditor();
  }
});

document.getElementById('openLandingPreview').addEventListener('click', ()=> window.open('index.html','_blank'));

// -------------------------------
// Settings modal (small utility actions)
// -------------------------------
function openSettingsModal(){
  const html = `
    <h3 style="margin:0 0 10px">Settings</h3>
    <p class="small-muted">Admin settings ‚Äî quick actions</p>
    <div style="margin-top:12px">
      <button id="clearReq" class="btn-ghost" style="margin-right:8px">Clear All Requests</button>
      <button id="exportReq" class="btn-ghost">Export Requests (JSON)</button>
    </div>
    <div style="margin-top:12px" class="small-muted">Close this modal when done.</div>
  `;
  openModal(html);

  document.getElementById('clearReq').addEventListener('click', ()=>{
    if(confirm('Clear ALL requests? This cannot be undone.')) {
      localStorage.removeItem('requests');
      renderTable();
      closeModal();
      alert('All requests cleared.');
    }
  });

  document.getElementById('exportReq').addEventListener('click', ()=>{
    const data = JSON.stringify(loadRequests(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'requests.json';
    a.click();
  });
}

// Modal helpers
function openModal(html){ document.getElementById('modalBox').innerHTML = html; document.getElementById('modalBackdrop').style.display = 'flex'; }
function closeModal(){ document.getElementById('modalBackdrop').style.display = 'none'; document.getElementById('modalBox').innerHTML = ''; }

// small helper to avoid issues with object copies
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// -------------------------------
// Init
// -------------------------------
renderTable();
</script>

</body>
</html>
