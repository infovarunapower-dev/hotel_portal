<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Admin Dashboard - Hotel Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--blue:#2563eb;--muted:#6b7280}
    body{font-family:Arial;margin:0;background:#f3f6fb;color:#111}
    header{background:var(--blue);color:#fff;padding:14px 20px}
    .wrap{max-width:1100px;margin:20px auto;padding:12px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:8px;background:#e6eefc;color:var(--blue);cursor:pointer}
    .tab.active{background:var(--blue);color:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input[type=text]{padding:8px;border-radius:6px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#f8fafc;color:var(--muted);font-weight:600}
    .btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;margin-left:6px}
    .btn.assign{background:#10b981;color:#fff}
    .btn.inprogress{background:#f59e0b;color:#fff}
    .btn.complete{background:#16a34a;color:#fff}
    .btn.delete{background:#ef4444;color:#fff}
    .small{font-size:13px;color:var(--muted)}
    .right{margin-left:auto}
    .status-tag{padding:6px 8px;border-radius:6px;font-weight:600;color:#fff}
    .status-Pending{background:#6b7280}
    .status-Assigned{background:#2563eb}
    .status-In\\ Progress{background:#f59e0b}
    .status-Completed{background:#16a34a}
    .select-staff{padding:6px;border-radius:6px}
    .topbar{display:flex;align-items:center;gap:12px}
    a.link{color:#fff;text-decoration:underline;margin-left:12px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div style="font-size:18px;font-weight:700">Admin Dashboard</div>
      <div style="margin-left:auto" class="small">
        Signed in as: <strong>Admin</strong>
        <a class="link" href="index.html">Home</a>
        <a class="link" href="login.html" id="logoutLink">Logout</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="tabs" id="tabs">
        <div class="tab active" data-cat="all">All</div>
        <div class="tab" data-cat="Housekeeping">üßπ Housekeeping</div>
        <div class="tab" data-cat="Travel">üöó Travel</div>
        <div class="tab" data-cat="Food">üçΩÔ∏è Food</div>
      </div>

      <input type="text" id="searchInput" placeholder="Search by name, room, or service..." style="flex:1"/>
      <select id="filterStatus">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Assigned">Assigned</option>
        <option value="In Progress">In Progress</option>
        <option value="Completed">Completed</option>
      </select>

      <select id="staffFilter">
        <option value="">All Staff</option>
      </select>

      <button class="btn delete" id="clearAllBtn">Clear All</button>
    </div>

    <table id="reqTable">
      <thead>
        <tr><th>#</th><th>Category</th><th>Service</th><th>Guest</th><th>Room</th><th>Time</th><th>Status</th><th>Assign / Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // Protect page: require admin auth
  if(localStorage.getItem('adminAuth') !== 'true'){
    alert('Admin not authenticated. Please login with PIN.');
    location.href = 'login.html';
  }

  // Ensure staff list exists
  if(!localStorage.getItem('staffList')) localStorage.setItem('staffList', JSON.stringify(['Raj','Kumar','Sita']));

  function getRequests(){ return JSON.parse(localStorage.getItem('requests') || '[]'); }
  function setRequests(arr){ localStorage.setItem('requests', JSON.stringify(arr)); }

  function populateStaffFilter(){
    const staff = JSON.parse(localStorage.getItem('staffList')||'[]');
    const sf = document.getElementById('staffFilter');
    sf.innerHTML = '<option value="">All Staff</option>' + staff.map(s=>`<option value="${s}">${s}</option>`).join('');
  }

  function statusTag(s){ 
    if(!s) s='Pending';
    const safe = s.replace(/ /g,'\\ ');
    return `<span class="status-tag status-${s.replace(/ /g,'-')}">${s}</span>`;
  }

  function render(){
    const all = getRequests();
    const tbody = document.querySelector('#reqTable tbody');
    tbody.innerHTML = '';
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const staffFilter = document.getElementById('staffFilter').value;
    const activeTab = document.querySelector('.tab.active').dataset.cat;

    const filtered = all.filter(r=>{
      if(activeTab!=='all' && r.type !== activeTab) return false;
      if(statusFilter && r.status !== statusFilter) return false;
      if(staffFilter && (r.assigned_to || '') !== staffFilter) return false;
      if(!search) return true;
      return (r.name||'').toLowerCase().includes(search) || (r.room||'').toString().toLowerCase().includes(search) || (r.service||'').toLowerCase().includes(search);
    });

    // show newest first
    filtered.slice().reverse().forEach((r, i) => {
      const globalIndex = (all.length - 1) - i;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${globalIndex+1}</td>
        <td>${r.type}</td>
        <td>${r.service}</td>
        <td>${r.name || '-'}</td>
        <td>${r.room || '-'}</td>
        <td>${r.time || '-'}</td>
        <td>${statusTag(r.status)}</td>
        <td>
          <select class="select-staff" data-idx="${globalIndex}">
            <option value="">Assign staff</option>
            ${JSON.parse(localStorage.getItem('staffList')).map(s=>`<option ${r.assigned_to===s?'selected':''} value="${s}">${s}</option>`).join('')}
          </select>
          <button class="btn assign" data-assign="${globalIndex}">Assign</button>
          <button class="btn inprogress" data-inprogress="${globalIndex}">Start</button>
          <button class="btn complete" data-complete="${globalIndex}">Complete</button>
          <button class="btn delete" data-delete="${globalIndex}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.addEventListener('click', (e) => {
    if(e.target.dataset.assign){
      const idx = parseInt(e.target.dataset.assign);
      const select = document.querySelector(`select.select-staff[data-idx="${idx}"]`);
      const staff = select.value;
      if(!staff){ alert('Choose staff to assign'); return; }
      const all = getRequests();
      all[idx].status = 'Assigned';
      all[idx].assigned_to = staff;
      setRequests(all);
      render();
    }
    if(e.target.dataset.inprogress){
      const idx = parseInt(e.target.dataset.inprogress);
      const all = getRequests(); all[idx].status='In Progress'; setRequests(all); render();
    }
    if(e.target.dataset.complete){
      const idx = parseInt(e.target.dataset.complete);
      const all = getRequests(); all[idx].status='Completed'; setRequests(all); render();
    }
    if(e.target.dataset.delete){
      const idx = parseInt(e.target.dataset.delete);
      if(!confirm('Delete this request?')) return;
      const all = getRequests(); all.splice(idx,1); setRequests(all); render();
    }
  });

  document.getElementById('tabs').addEventListener('click', (ev) => {
    if(!ev.target.classList.contains('tab')) return;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    ev.target.classList.add('active'); render();
  });

  document.getElementById('searchInput').addEventListener('input', render);
  document.getElementById('filterStatus').addEventListener('change', render);
  document.getElementById('staffFilter').addEventListener('change', render);

  document.getElementById('clearAllBtn').addEventListener('click', () => {
    if(!confirm('Delete all requests?')) return;
    localStorage.removeItem('requests'); render();
  });

  document.getElementById('logoutLink').addEventListener('click', ()=>{
    localStorage.removeItem('adminAuth');
    // keep PIN stored though
  });

  // Init
  populateStaffFilter(); render();
</script>
</body>
</html>
